# 要件定義書 — **prompt‑scanner**

*Version 0.9  |  Last Updated: 2025‑06‑18*

---

## 目次

1. [概要](#概要)
2. [用語定義](#用語定義)
3. [背景と課題](#背景と課題)
4. [システム概要](#システム概要)

   1. [アーキテクチャ](#アーキテクチャ)
   2. [デプロイ想定](#デプロイ想定)
5. [機能要件](#機能要件)
6. [非機能要件](#非機能要件)
7. [実装詳細](#実装詳細)

   1. [主要データ構造](#主要データ構造)
   2. [代表的アルゴリズム](#代表的アルゴリズム)
   3. [型安全対応](#型安全対応)
8. [進捗状況](#進捗状況)
9. [ロードマップ](#ロードマップ)
10. [リスクと対策](#リスクと対策)
11. [参考文献](#参考文献)

---

## 概要

| 項目          | 内容                                                                                                             |
| ----------- | -------------------------------------------------------------------------------------------------------------- |
| **プロジェクト名** | prompt‑scanner                                                                                                 |
| **目的**      | Word / PowerPoint / PDF 内に潜む “人間には判読不能だが LLM には届く” テキスト（透明・極小・低コントラスト・ゼロ幅・隠し XML 等）を検出し、プロンプトインジェクションを未然に警告する。 |
| **利用技術**    | Python 3.9+ / python‑docx / python‑pptx / PyPDF2・pdfminer.six / Streamlit / oletools 等                         |
| **対象ユーザー**  | LLM アプリ開発者・セキュリティ担当・ドキュメント検査担当者                                                                                |

---

## 用語定義

| 用語          | 説明                                                                                                             |
| ----------- | -------------------------------------------------------------------------------------------------------------- |
| **隠匿テキスト**  | 通常の閲覧・印刷では確認できないが、ファイル内部に存在するテキスト。                                                                             |
| **Finding** | 1 件の検出結果を表すデータ構造（`location`, `snippet`）。                                                                       |
| **MVP**     | Minimum Viable Product。透明・極小・低コントラスト・Hidden 属性・ゼロ幅・`/CA 0`・`Tr 3`・非表示スライド・`customXml`・埋め込み JS を検査対象とする最初のリリース。 |

---

## 背景と課題

* 透過フォントを悪用したプロンプトインジェクション事例が報告されており、**実際に LLM へ渡るテキスト層の可視化**が急務。
* MS Word の `Font.hidden`、PowerPoint の `SlideShowTransition.Hidden`・α値、PDF の `Tr 3`・`/CA 0` など多様な不可視テクニックが存在。
* ゼロ幅・制御系 Unicode (UCD Cf) も多数。
* 既存 DLP／AV 製品では検出が困難であり **専用スキャナ** が必要。

---

## システム概要

### アーキテクチャ

```text
┌───────────┐    .docx/.pptx/.pdf   ┌────────────┐
│  Streamlit │─── file upload  ────▶│ scanner.*  │
└───────────┘                      └────┬───────┘
            ▲  Findings(list)              │
            │                              ▼
        Quick CLI                JSON / DataFrame
```

* **UI 層** `app.py` — `st.file_uploader` で複数ファイルを受領
* **CLI 層** `scanner/cli.py` — `python -m scanner.cli <file>` でバッチ／テスト用
* **ドメイン層** `scanner/` パッケージ

  * `base.py`: `Finding` dataclass & `BaseScanner` 抽象基底
  * `word.py` / `pptx.py` / `pdf.py`: 各ドキュメント形式のスキャナ
  * `unicode_utils.py`: コントラスト計算 & 不可視 Unicode 判定
  * プラグイン方式で SmartArt / VBA / RichMedia などを後置き拡張

### デプロイ想定

* **ランタイム**: Docker (`python:3.11‑slim`) + gunicorn + Streamlit
* **セキュリティ**: アップロードファイルは一時保存し、セッション終了時に即削除 (GDPR など考慮)

---

## 機能要件

| ID   | 機能                  | 詳細                                                           |
| ---- | ------------------- | ------------------------------------------------------------ |
| FR‑1 | **ファイルアップロード**      | `.docx` / `.pptx` / `.pdf` を複数同時アップロード                       |
| FR‑2 | **隠匿テキスト検出 ― Word** | `Font.hidden` / 低コントラスト / 極小フォント / ゼロ幅 Unicode / `customXml` |
| FR‑3 | **隠匿テキスト検出 ― PPTX** | shape 透明度・明度 / 非表示スライド / 極小フォント / ゼロ幅                        |
| FR‑4 | **隠匿テキスト検出 ― PDF**  | `/CA 0` 透明度 / `Tr 3` / `/JavaScript` / Invisible OCR         |
| FR‑5 | **CLI アクセス**        | `quick_scan(Path)` を公開し CI・自動テスト・バッチ処理に利用                    |
| FR‑6 | **結果表示**            | 検出有無 (True/False) と `Finding` リストを UI / CLI 両方で整形            |
| FR‑7 | **ロギング**            | INFO: 処理開始/終了、DEBUG: 各検査詳細、ERROR: 読み込み失敗                     |

---

## 非機能要件

| 区分     | 要件                                                  |
| ------ | --------------------------------------------------- |
| 性能     | 10 MB 以下のファイルを **5 秒以内** で解析 (ローカル実測)               |
| セキュリティ | ファイルは一時フォルダにのみ保存し、解析後即削除。VBA マクロは実行せず文字列解析 (olevba) |
| 拡張性    | `BaseScanner` を継承するサブクラス追加で新形式／新手法に追随               |
| 可搬性    | 依存を `requirements.txt` に明記、CI で動作検証                 |
| 可観測性   | Streamlit UI で処理時間を表示、詳細エラーはログへ出力                   |

---

## 実装詳細

### 主要データ構造

```python
@dataclass
class Finding:
    location: str   # 例: '段落 3' / 'slide 2'
    snippet: str    # 先頭40文字 + '…'
```

### 代表的アルゴリズム

* **コントラスト判定** 
  WCAG 相対輝度式 `(L1 + 0.05) / (L2 + 0.05) ≤ 1.3` を「不可視」の閾値と定義
* **透明度判定** 
  alpha ≤ 15 % (pptx: α値, pdf: `/CA 0.0x`) を “ほぼ透明” と見なす
* **ゼロ幅 Unicode** 
  UCD カテゴリ `Cf` / `Zl` / `Zp` に該当する文字をフィルタ
* **PDF 埋め込み JS** 
  `/JavaScript`・`/AA` 辞書を正規表現検索

### 型安全対応

* `Document(str(path))` で `Path` → `str` へ安全キャスト
* `cast(Tuple[int,int,int], (col.rgb[0], …))` で RGB タプル長を固定
* `if col is None or col.rgb is None:` で OptionalSubscript を回避

---

## 進捗状況

| 状態 | 項目                                             | 備考                                          |
| -- | ---------------------------------------------- | ------------------------------------------- |
| ✅  | ディレクトリ構成作成                                     | `prompt-scanner/` 完成                        |
| ✅  | `unicode_utils.py` / `base.py` / 各 Scanner MVP | Word / PPTX / PDF 基本検査ロジック                  |
| ✅  | CLI (`scanner/cli.py`)                         | `quick_scan` 動作確認                           |
| ⏳  | Streamlit UI                                   | アップロード & DataFrame 表示のみ暫定                   |
| ⏳  | 単体テスト (`pytest`)                               | サンプルファイル作成中                                 |
| ⏳  | プラグイン拡張                                        | SmartArt / VBA / AcroForm / RichMedia / OCG |

---

## ロードマップ

| フェーズ                  | 内容                                                        | 予定      |
| --------------------- | --------------------------------------------------------- | ------- |
| **UI 強化**             | 結果表の色分け表示、CSV エクスポート                                      | 2025‑07 |
| **深層解析プラグイン**         | VBA/OLE, SmartArt/XML, PDF `/AcroForm` & `/EmbeddedFiles` | 2025‑08 |
| **レポート機能**            | HTML/PDF 自動生成 & スコアリング                                    | 2025‑09 |
| **CI/CD & Docker 配布** | GitHub Actions: pytest + flake8 + mypy                    | 2025‑09 |
| **社内導入トライアル**         | フィードバックで閾値調整                                              | 2025‑10 |

---

## リスクと対策

| リスク                | 影響     | 対策                  |
| ------------------ | ------ | ------------------- |
| 新種のステガノ／難読エンコーディング | 検出漏れ   | プラグイン方式で継続的アップデート   |
| 大容量ファイル (> 100 MB) | 解析時間超過 | サイズ上限チェック・ストリーミング解析 |
| **誤検知**            | 作業効率低下 | スコアリング閾値調整・手動レビュ UI |

---

## 参考文献

---

> **備考**
> 本ドキュメントは MVP 実装開始時点の要件を整理したものであり、仕様変更やレビューに応じてバージョンアップを行います。フィードバックは随時歓迎します。
